<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Planning Poker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Библиотека MQTT для связи -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: #0f111a;
            color: #ffffff;
            overflow-x: hidden;
        }

        .bg-card {
            background: #1a1d29;
            border: 1px solid #2d3245;
        }

        .accent-color {
            color: #00f2ff;
        }

        .bg-accent {
            background: #00f2ff;
        }

        /* Стили карт */
        .poker-card {
            perspective: 1000px;
            width: 80px;
            height: 115px;
        }

        .poker-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            transform-style: preserve-3d;
        }

        .is-flipped .poker-card-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 900;
        }

        .card-front {
            background: #232736;
            border: 2px solid #3d445e;
        }

        .card-back {
            background: #ffffff;
            color: #0f111a;
            transform: rotateY(180deg);
        }

        .voted-border {
            border-color: #00f2ff !important;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
        }

        /* Кнопки выбора */
        .choice-btn {
            transition: all 0.2s;
            background: #1a1d29;
            border: 1px solid #2d3245;
        }

        .choice-btn:hover {
            transform: translateY(-5px);
            border-color: #00f2ff;
        }

        .choice-btn.active {
            background: #00f2ff;
            color: #000;
            box-shadow: 0 0 20px #00f2ff;
        }
    </style>
</head>

<body class="min-h-screen">

    <div class="max-w-6xl mx-auto p-6">
        <!-- Шапка -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
            <h1 class="text-3xl font-black tracking-tighter">PLANNING<span class="accent-color">POKER</span></h1>

            <div class="flex items-center gap-4 bg-card px-4 py-2 rounded-2xl">
                <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                <span class="text-xs font-bold opacity-70 uppercase tracking-widest">Room: <span
                        id="room-id">...</span></span>
                <button onclick="copyRoomLink()" class="hover:text-cyan-400 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
                    </svg>
                </button>
            </div>

            <div id="controls" class="hidden flex gap-3">
                <button onclick="broadcastAction('reveal')"
                    class="bg-accent text-black px-6 py-2 rounded-full font-bold hover:scale-105 transition">REVEAL</button>
                <button onclick="broadcastAction('reset')"
                    class="bg-white/10 hover:bg-white/20 px-6 py-2 rounded-full font-bold transition">RESET</button>
            </div>
        </header>

        <!-- Экран входа -->
        <div id="login-screen"
            class="max-w-md mx-auto bg-card p-10 rounded-3xl shadow-2xl text-center border-t-4 border-cyan-500">
            <h2 class="text-2xl font-bold mb-6">Готовы к оценке?</h2>
            <input type="text" id="username" placeholder="Ваше имя" maxlength="12"
                class="w-full bg-black/30 border border-slate-700 rounded-xl px-5 py-4 mb-6 focus:outline-none focus:border-cyan-500 text-lg text-center">
            <button onclick="joinGame()"
                class="w-full bg-accent text-black py-4 rounded-xl font-black text-lg hover:shadow-[0_0_20px_#00f2ff] transition">ПРИСОЕДИНИТЬСЯ</button>
        </div>

        <!-- Игровое поле -->
        <div id="game-screen" class="hidden">
            <div id="players-grid" class="flex flex-wrap justify-center gap-10 mb-40">
                <!-- Карточки игроков появятся здесь -->
            </div>

            <!-- Выбор карты (Sticky Bottom) -->
            <div class="fixed bottom-8 left-0 right-0 px-4">
                <div
                    class="max-w-4xl mx-auto bg-card/80 backdrop-blur-xl p-4 rounded-[2.5rem] flex justify-center gap-3 overflow-x-auto border border-white/5">
                    <script>
                        ['0', '1', '2', '3', '5', '8', '13', '21', '?', '☕'].forEach(v => {
                            document.write(`<button onclick="pickCard('${v}')" class="choice-btn min-w-[3.5rem] h-20 rounded-2xl font-bold text-xl">${v}</button>`);
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Генерируем ID комнаты и ID игрока
        const roomHash = window.location.hash.replace('#', '') || Math.random().toString(36).substring(7);
        window.location.hash = roomHash;
        document.getElementById('room-id').innerText = roomHash.toUpperCase();

        const myPlayerId = Math.random().toString(36).substring(7);
        let myName = '';
        let players = {};
        let isRevealed = false;

        // Настройки MQTT (используем публичный брокер HiveMQ)
        const topic = `astro_poker/rooms/${roomHash}`;
        const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

        client.on('connect', () => {
            document.getElementById('status-dot').classList.replace('bg-red-500', 'bg-emerald-500');
            client.subscribe(topic);
        });

        // Слушаем входящие сообщения
        client.on('message', (t, message) => {
            const data = JSON.parse(message.toString());

            if (data.type === 'update') {
                players[data.id] = { name: data.name, vote: data.vote, ts: Date.now() };
                render();
            } else if (data.type === 'reveal') {
                isRevealed = true;
                render();
            } else if (data.type === 'reset') {
                isRevealed = false;
                Object.keys(players).forEach(id => players[id].vote = null);
                document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('active'));
                render();
            } else if (data.type === 'ping') {
                // Кто-то зашел, отправляем ему свои данные
                if (myName) sendUpdate(players[myPlayerId]?.vote || null);
            }
        });

        function joinGame() {
            myName = document.getElementById('username').value.trim();
            if (!myName) return;

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');

            // Сообщаем всем, что мы зашли
            broadcastAction('ping');
            sendUpdate(null);

            // Каждые 5 секунд подтверждаем присутствие (heartbeat)
            setInterval(() => sendUpdate(players[myPlayerId]?.vote || null), 5000);
        }

        function pickCard(val) {
            document.querySelectorAll('.choice-btn').forEach(b => {
                b.classList.toggle('active', b.innerText === val);
            });
            sendUpdate(val);
        }

        function sendUpdate(vote) {
            const payload = {
                type: 'update',
                id: myPlayerId,
                name: myName,
                vote: vote
            };
            client.publish(topic, JSON.stringify(payload));
        }

        function broadcastAction(type) {
            client.publish(topic, JSON.stringify({ type }));
        }

        function render() {
            const grid = document.getElementById('players-grid');
            grid.innerHTML = '';
            const now = Date.now();

            Object.keys(players).forEach(id => {
                const p = players[id];
                // Убираем тех, кто не пинговался > 15 сек
                if (now - p.ts > 15000) return;

                const hasVoted = p.vote !== null && p.vote !== undefined;

                const cardMarkup = `
                    <div class="flex flex-col items-center gap-4">
                        <div class="poker-card ${isRevealed ? 'is-flipped' : ''}">
                            <div class="poker-card-inner">
                                <div class="card-face card-front ${hasVoted ? 'voted-border' : ''}">
                                    ${hasVoted ? '<div class="w-4 h-4 bg-cyan-400 rounded-full animate-pulse shadow-[0_0_10px_#00f2ff]"></div>' : '<span class="text-[10px] opacity-20 uppercase font-black">Think</span>'}
                                </div>
                                <div class="card-face card-back shadow-2xl border-2 border-white/10">
                                    ${p.vote || ''}
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="font-bold text-sm tracking-widest ${id === myPlayerId ? 'accent-color' : ''}">${p.name.toUpperCase()}</p>
                            ${id === myPlayerId ? '<p class="text-[8px] font-black opacity-50">YOU</p>' : ''}
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', cardMarkup);
            });
        }

        function copyRoomLink() {
            navigator.clipboard.writeText(window.location.href);
            alert('Ссылка скопирована!');
        }

        // Очистка списка каждые 2 сек
        setInterval(render, 2000);
    </script>
</body>

</html>