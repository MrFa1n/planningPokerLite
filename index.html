<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #090a0f;
            color: #ffffff;
            min-height: 100vh;
        }

        .bg-glass {
            background: rgba(23, 25, 35, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .poker-card {
            perspective: 1000px;
            width: 90px;
            height: 130px;
        }

        .poker-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d;
        }

        .is-flipped .poker-card-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .card-front {
            background: #1a1c26;
            border: 2px solid #2d3142;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .card-back {
            background: #ffffff;
            color: #090a0f;
            transform: rotateY(180deg);
            font-size: 2rem;
            font-weight: 800;
        }

        .role-fe {
            color: #3b82f6;
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .role-be {
            color: #ef4444;
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .role-qa {
            color: #10b981;
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .role-ba {
            color: #6366f1;
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .role-pm {
            color: #f59e0b;
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .role-other {
            color: #94a3b8;
            border-color: #475569;
            background: rgba(148, 163, 184, 0.1);
        }

        .role-observer {
            color: #ffffff;
            border-color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }

        .voted-border {
            border-color: #00f2ff !important;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        }

        .my-card-glow {
            box-shadow: 0 0 0 3px #00f2ff, 0 0 30px rgba(0, 242, 255, 0.2);
            border-radius: 20px;
        }

        .choice-btn {
            background: #1a1c26;
            border: 1px solid #2d3142;
            transition: all 0.2s;
        }

        .choice-btn:hover:not(:disabled) {
            border-color: #00f2ff;
            transform: translateY(-3px);
        }

        .choice-btn.active {
            background: #00f2ff;
            color: #000;
            font-weight: 800;
            border-color: #00f2ff;
        }

        .stats-panel {
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .timer-active {
            animation: pulse-red 1s infinite;
        }

        @keyframes pulse-red {
            0% {
                color: #ffffff;
            }

            50% {
                color: #ef4444;
            }

            100% {
                color: #ffffff;
            }
        }

        .roles-disabled {
            opacity: 0.3;
            pointer-events: none;
            filter: grayscale(1);
        }
    </style>
</head>

<body class="p-4 md:p-6">

    <div class="max-w-7xl mx-auto">
        <header
            class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4 bg-glass p-4 rounded-3xl shadow-xl">
            <div class="flex items-center gap-4">
                <div
                    class="w-10 h-10 bg-cyan-500/20 rounded-xl flex items-center justify-center border border-cyan-500/30">
                    <div id="net-status" class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_red]"
                        title="–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏"></div>
                </div>
                <div>
                    <h1 class="text-xl font-black italic tracking-tighter uppercase">Planning<span
                            class="text-cyan-400">POKER</span>
                    </h1>
                    <button onclick="copyRoomLink()"
                        class="text-[10px] text-slate-400 hover:text-cyan-400 flex items-center gap-1 transition font-bold uppercase tracking-wider"
                        title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É">
                        ROOM: <span id="room-id" class="text-white">...</span>
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"
                                stroke-width="2" />
                        </svg>
                    </button>
                </div>
            </div>

            <div id="timer-display"
                class="hidden flex items-center gap-2 bg-white/5 px-4 py-2 rounded-2xl border border-white/10"
                title="–í—Ä–µ–º—è –¥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Å–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç">
                <span class="text-[10px] font-black uppercase text-slate-500">–ê–≤—Ç–æ-–≤—Å–∫—Ä—ã—Ç–∏–µ:</span>
                <span id="timer-seconds" class="text-xl font-black text-cyan-400">00:00</span>
            </div>

            <div id="user-badge"
                class="hidden flex items-center gap-3 bg-white/5 p-2 pr-4 rounded-2xl border border-white/5">
                <div id="my-role-icon"
                    class="w-8 h-8 rounded-lg flex items-center justify-center font-bold text-[10px] border">?</div>
                <div>
                    <p class="text-[9px] text-slate-500 font-black uppercase leading-none mb-1">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</p>
                    <div class="flex items-center gap-2">
                        <p id="my-display-name" class="font-bold text-sm text-cyan-400 leading-tight">...</p>
                        <button onclick="leaveGame()"
                            class="text-[9px] font-black uppercase text-red-400 border border-red-400/30 px-1.5 py-0.5 rounded hover:bg-red-400/10 transition"
                            title="–í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã –∏ —Å–º–µ–Ω–∏—Ç—å –∏–º—è –∏–ª–∏ —Ä–æ–ª—å">–í—ã–π—Ç–∏</button>
                    </div>
                </div>
            </div>

            <div id="controls" class="hidden flex flex-wrap items-center gap-3">
                <div id="pm-controls" class="hidden flex items-center gap-2 border-r border-white/10 pr-3">
                    <select id="timer-select"
                        class="bg-slate-800 text-[10px] font-bold uppercase rounded-lg px-2 py-2 border border-slate-700 outline-none focus:border-cyan-500"
                        title="–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è —Ç–∞–π–º–µ—Ä–∞">
                        <option value="0">–ë–µ–∑ —Ç–∞–π–º–µ—Ä–∞</option>
                        <option value="10">10 —Å–µ–∫—É–Ω–¥</option>
                        <option value="15">15 —Å–µ–∫—É–Ω–¥</option>
                        <option value="30">30 —Å–µ–∫—É–Ω–¥</option>
                        <option value="45">45 —Å–µ–∫—É–Ω–¥</option>
                        <option value="60">60 —Å–µ–∫—É–Ω–¥</option>
                    </select>
                    <button id="btn-timer-start" onclick="startTimer()"
                        class="p-2 bg-white/5 hover:bg-cyan-500/20 border border-white/10 rounded-lg transition"
                        title="–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç">
                        <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </div>

                <div id="pm-only-msg"
                    class="text-[9px] text-slate-500 mr-2 font-black uppercase hidden tracking-widest">–¢–æ–ª—å–∫–æ PM
                    —É–ø—Ä–∞–≤–ª—è–µ—Ç</div>
                <button id="btn-reveal" onclick="broadcastAction('reveal')"
                    class="px-6 py-2 bg-cyan-500 text-black font-black rounded-xl hover:scale-105 transition disabled:opacity-30 uppercase text-xs"
                    title="–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ü–µ–Ω–∫–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤">–í—Å–∫—Ä—ã—Ç—å</button>
                <button id="btn-reset" onclick="broadcastAction('reset')"
                    class="px-6 py-2 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 transition disabled:opacity-30 uppercase text-xs"
                    title="–û—á–∏—Å—Ç–∏—Ç—å –æ—Ü–µ–Ω–∫–∏ –∏ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥">–°–±—Ä–æ—Å</button>
            </div>
        </header>

        <div id="stats-panel"
            class="stats-panel hidden mb-8 bg-cyan-500/10 border border-cyan-500/20 p-6 rounded-[2rem] flex flex-wrap justify-around gap-4 text-center">
            <div class="px-4 text-center" title="–°—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –≤—Å–µ—Ö –æ—Ü–µ–Ω–æ–∫">
                <p class="text-[10px] text-cyan-500 font-black uppercase mb-1 tracking-widest">–°—Ä–µ–¥–Ω–µ–µ</p>
                <p id="stat-avg" class="text-4xl font-black text-white">-</p>
            </div>
            <div class="px-4 border-x border-white/10" title="–ó–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Å–ø–∏—Å–∫–∞ –æ—Ü–µ–Ω–æ–∫">
                <p class="text-[10px] text-cyan-500 font-black uppercase mb-1 tracking-widest">–ú–µ–¥–∏–∞–Ω–∞</p>
                <p id="stat-med" class="text-4xl font-black text-white">-</p>
            </div>
            <div class="px-4" title="–°–∞–º–∞—è —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∞—è—Å—è –æ—Ü–µ–Ω–∫–∞">
                <p class="text-[10px] text-cyan-500 font-black uppercase mb-1 tracking-widest">–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</p>
                <p id="stat-mode" class="text-4xl font-black text-white">-</p>
            </div>
        </div>

        <div id="login-screen" class="max-w-md mx-auto bg-glass p-8 rounded-[2.5rem] shadow-2xl border border-white/5">
            <h2 class="text-2xl font-black mb-6 text-center tracking-tight uppercase">–í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É</h2>
            <div class="space-y-5">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 mb-1 block">–í–∞—à–µ –∏–º—è:</label>
                    <input type="text" id="username" placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?" maxlength="12"
                        class="w-full bg-black/40 border border-slate-800 rounded-2xl px-6 py-4 focus:border-cyan-500 outline-none text-center font-bold"
                        title="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏">
                </div>

                <div id="role-selection-container">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 mb-1 block">–í–∞—à–∞ —Ä–æ–ª—å:</label>
                    <div id="roles-grid" class="grid grid-cols-3 gap-2 transition-all duration-300">
                        <button onclick="setRole('FE', this)"
                            class="role-btn py-3 bg-white/5 border border-slate-800 rounded-xl text-[10px] font-black uppercase transition-all hover:border-slate-600 opacity-50"
                            title="Frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫">Frontend</button>
                        <button onclick="setRole('BE', this)"
                            class="role-btn py-3 bg-white/5 border border-slate-800 rounded-xl text-[10px] font-black uppercase transition-all hover:border-slate-600 opacity-50"
                            title="Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫">Backend</button>
                        <button onclick="setRole('QA', this)"
                            class="role-btn py-3 bg-white/5 border border-slate-800 rounded-xl text-[10px] font-black uppercase transition-all hover:border-slate-600 opacity-50"
                            title="–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫">QA</button>
                        <button onclick="setRole('BA', this)"
                            class="role-btn py-3 bg-white/5 border border-slate-800 rounded-xl text-[10px] font-black uppercase transition-all hover:border-slate-600 opacity-50"
                            title="–ë–∏–∑–Ω–µ—Å/–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫">BA/SA</button>
                        <button onclick="setRole('PM', this)"
                            class="role-btn py-3 bg-white/5 border border-slate-800 rounded-xl text-[10px] font-black uppercase transition-all hover:border-slate-600 opacity-50"
                            title="–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (–£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–Ω–∞—Ç–æ–π)">PM</button>
                        <button onclick="setRole('Other', this)"
                            class="role-btn py-3 bg-white/5 border border-slate-800 rounded-xl text-[10px] font-black uppercase transition-all hover:border-slate-600 opacity-50"
                            title="–î—Ä—É–≥–∞—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è">Other</button>
                    </div>
                </div>

                <div class="pt-2">
                    <label
                        class="flex items-center gap-3 p-4 bg-white/5 rounded-2xl cursor-pointer hover:bg-white/10 border border-transparent hover:border-white/5"
                        title="–í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –≤—ã —Ç–æ–ª—å–∫–æ —Å–º–æ—Ç—Ä–∏—Ç–µ –∏ –Ω–µ –≥–æ–ª–æ—Å—É–µ—Ç–µ">
                        <input type="checkbox" id="is-observer" onchange="toggleObserverMode(this.checked)"
                            class="w-4 h-4 accent-cyan-400">
                        <span class="text-sm font-bold">–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å (–Ω–µ –≥–æ–ª–æ—Å—É—é)</span>
                    </label>
                </div>

                <button onclick="joinGame()"
                    class="w-full bg-cyan-500 text-black py-4 rounded-2xl font-black text-lg hover:shadow-lg transition mt-4 uppercase">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div id="players-grid" class="flex flex-wrap justify-center gap-8 md:gap-10 mb-64"
                title="–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –∏—Ö –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å"></div>

            <div id="hand-panel" class="fixed bottom-6 left-0 right-0 px-4">
                <div class="max-w-4xl mx-auto bg-glass p-6 rounded-[2.5rem] shadow-3xl border border-white/10 relative overflow-hidden"
                    title="–í–∞—à–∞ –∫–æ–ª–æ–¥–∞ –∫–∞—Ä—Ç –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è">
                    <div id="lock-overlay"
                        class="hidden absolute inset-0 bg-black/80 rounded-[2.5rem] flex items-center justify-center z-10 backdrop-blur-[3px]">
                        <span
                            class="text-cyan-400 font-black uppercase text-xs flex items-center gap-2 tracking-widest">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z">
                                </path>
                            </svg>
                            –í—Å–∫—Ä—ã—Ç–æ. –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                        </span>
                    </div>
                    <div class="flex flex-wrap justify-center gap-2 max-h-48 overflow-y-auto pr-1">
                        <script>
                            for (let i = 1; i <= 20; i++) {
                                document.write(`<button onclick="pickCard('${i}')" class="choice-btn w-11 h-14 rounded-xl font-black text-sm" title="–û—Ü–µ–Ω–∏—Ç—å –≤ ${i} –µ–¥–∏–Ω–∏—Ü">${i}</button>`);
                            }
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roomHash = window.location.hash.replace('#', '') || Math.random().toString(36).substring(7);
        window.location.hash = roomHash;
        document.getElementById('room-id').innerText = roomHash.toUpperCase();

        const myId = Math.random().toString(36).substring(7);
        let myName = '', myRole = '', isObserver = false, players = {}, isRevealed = false;

        let timerEndTimestamp = null;
        let timerInterval = null;
        let heartbeatInterval = null;

        const topic = `mgmt_poker_v7/rooms/${roomHash}`;
        const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

        client.on('connect', () => {
            document.getElementById('net-status').className = 'w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]';
            client.subscribe(topic);
            broadcastAction('ping');
        });

        client.on('message', (t, msg) => {
            const data = JSON.parse(msg.toString());

            if (data.type === 'update') {
                players[data.id] = { ...data, ts: Date.now() };
                render();
            }
            else if (data.type === 'leave') {
                delete players[data.id];
                render();
            }
            else if (data.type === 'reveal') { isRevealed = true; stopLocalTimer(); render(); }
            else if (data.type === 'reset') {
                isRevealed = false;
                stopLocalTimer();
                Object.keys(players).forEach(id => players[id].vote = null);
                document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('active'));
                render();
            }
            else if (data.type === 'timer_start') { startLocalTimer(data.endTime); }
            else if (data.type === 'ping') {
                if (myName) {
                    sendUpdate(players[myId]?.vote || null);
                    if (timerEndTimestamp && myRole === 'PM') {
                        broadcastTimer(timerEndTimestamp);
                    }
                }
            }
        });


        function toggleObserverMode(checked) {
            const grid = document.getElementById('roles-grid');
            if (checked) {
                myRole = '';
                grid.classList.add('roles-disabled');
                document.querySelectorAll('.role-btn').forEach(b => b.className = 'role-btn py-3 bg-white/5 border border-slate-800 rounded-xl text-[10px] font-black uppercase opacity-50');
            } else {
                grid.classList.remove('roles-disabled');
            }
        }

        function setRole(role, btn) {
            document.getElementById('is-observer').checked = false;
            document.getElementById('roles-grid').classList.remove('roles-disabled');

            myRole = role;
            document.querySelectorAll('.role-btn').forEach(b => b.className = 'role-btn py-3 bg-white/5 border border-slate-800 rounded-xl text-[10px] font-black uppercase opacity-50');
            btn.className = 'role-btn py-3 bg-cyan-500/20 border border-cyan-500 rounded-xl text-[10px] font-black uppercase text-cyan-400 shadow-lg';
        }


        function joinGame() {
            const nameInput = document.getElementById('username');
            myName = nameInput.value.trim();
            isObserver = document.getElementById('is-observer').checked;

            if (!myName) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è."); return; }
            if (!isObserver && !myRole) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –∏–ª–∏ —Ä–µ–∂–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è."); return; }

            if (isObserver) myRole = 'Observer';

            if (myRole === 'PM') {
                const pmExists = Object.values(players).some(p => p.role === 'PM' && (Date.now() - p.ts < 15000));
                if (pmExists) {
                    alert("–í —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ —É–∂–µ –µ—Å—Ç—å PM. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é —Ä–æ–ª—å.");
                    return;
                }
            }

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('user-badge').classList.remove('hidden');

            if (myRole === 'PM') {
                document.getElementById('pm-controls').classList.remove('hidden');
                document.getElementById('btn-reveal').disabled = false;
                document.getElementById('btn-reset').disabled = false;
                document.getElementById('pm-only-msg').classList.add('hidden');
            } else {
                document.getElementById('pm-controls').classList.add('hidden');
                document.getElementById('btn-reveal').disabled = true;
                document.getElementById('btn-reset').disabled = true;
                document.getElementById('pm-only-msg').classList.remove('hidden');
            }

            document.getElementById('my-display-name').innerText = myName;
            const icon = document.getElementById('my-role-icon');
            icon.innerText = (myRole === 'Observer') ? 'üëÅÔ∏è' : myRole;
            icon.className = `w-8 h-8 rounded-lg flex items-center justify-center font-black text-[10px] role-${myRole.toLowerCase().replace('/', '')}`;

            if (isObserver) document.getElementById('hand-panel').classList.add('hidden');
            else document.getElementById('hand-panel').classList.remove('hidden');

            sendUpdate(null);
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => sendUpdate(players[myId]?.vote || null), 5000);
        }

        function leaveGame() {
            client.publish(topic, JSON.stringify({ type: 'leave', id: myId }));
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            stopLocalTimer();
            myName = '';
            myRole = '';
            isObserver = false;
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('controls').classList.add('hidden');
            document.getElementById('user-badge').classList.add('hidden');
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('is-observer').checked = false;
            document.getElementById('roles-grid').classList.remove('roles-disabled');
            document.querySelectorAll('.role-btn').forEach(b => b.className = 'role-btn py-3 bg-white/5 border border-slate-800 rounded-xl text-[10px] font-black uppercase opacity-50');
        }

        function startTimer() {
            const seconds = parseInt(document.getElementById('timer-select').value);
            if (seconds <= 0) return;
            broadcastTimer(Date.now() + (seconds * 1000));
        }

        function broadcastTimer(endTime) {
            client.publish(topic, JSON.stringify({ type: 'timer_start', endTime: endTime }));
        }

        function startLocalTimer(endTime) {
            stopLocalTimer();
            timerEndTimestamp = endTime;
            document.getElementById('timer-display').classList.remove('hidden');
            timerInterval = setInterval(() => {
                const diff = Math.max(0, Math.floor((timerEndTimestamp - Date.now()) / 1000));
                if (diff <= 0) {
                    stopLocalTimer();
                    if (myRole === 'PM') broadcastAction('reveal');
                } else {
                    const m = Math.floor(diff / 60);
                    const s = diff % 60;
                    document.getElementById('timer-seconds').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    if (diff <= 10) document.getElementById('timer-seconds').classList.add('timer-active');
                    else document.getElementById('timer-seconds').classList.remove('timer-active');
                }
            }, 500);
        }

        function stopLocalTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            timerEndTimestamp = null;
            document.getElementById('timer-display').classList.add('hidden');
        }

        function pickCard(val) {
            if (isRevealed || isObserver) return;
            let currentVote = players[myId]?.vote;
            let finalVote = (currentVote === val) ? null : val;
            document.querySelectorAll('.choice-btn').forEach(b => b.classList.toggle('active', b.innerText === finalVote));
            sendUpdate(finalVote);
        }

        function sendUpdate(vote) {
            if (!myName) return;
            client.publish(topic, JSON.stringify({ type: 'update', id: myId, name: myName, role: myRole, isObserver, vote }));
        }

        function broadcastAction(type) {
            client.publish(topic, JSON.stringify({ type }));
        }

        function render() {
            const grid = document.getElementById('players-grid');
            grid.innerHTML = '';
            const now = Date.now();
            const activeVotes = [];

            document.getElementById('lock-overlay').classList.toggle('hidden', !isRevealed);

            Object.keys(players).sort().forEach(id => {
                const p = players[id];
                if (now - p.ts > 15000) return;

                const hasVoted = p.vote !== null && p.vote !== 'null' && p.vote !== undefined;
                if (hasVoted && !isNaN(p.vote)) activeVotes.push(Number(p.vote));

                const roleKey = p.role.toLowerCase().replace('/', '');
                const roleClass = `role-${roleKey}`;

                const cardMarkup = `
                    <div class="flex flex-col items-center gap-4 ${id === myId ? 'my-card-glow p-2' : ''}">
                        <div class="poker-card ${isRevealed ? 'is-flipped' : ''}">
                            <div class="poker-card-inner">
                                <div class="card-face card-front ${hasVoted ? 'voted-border' : ''}">
                                    ${p.role === 'Observer' ? '<span class="text-3xl">üëÅÔ∏è</span>' :
                        (hasVoted ? '<div class="w-3 h-3 bg-cyan-400 rounded-full animate-pulse shadow-[0_0_10px_#00f2ff]"></div>' : '<span class="text-[8px] opacity-10 font-black uppercase">–ñ–¥–µ—Ç...</span>')}
                                </div>
                                <div class="card-face card-back shadow-2xl">${p.vote || ''}</div>
                            </div>
                        </div>
                        <div class="text-center">
                            <span class="text-[8px] px-2 py-0.5 rounded-md border ${roleClass} font-black mb-1 inline-block uppercase tracking-tighter">${p.role}</span>
                            <p class="font-bold text-[13px] tracking-tight ${id === myId ? 'text-cyan-400 font-black' : 'text-slate-300'}">${p.name}</p>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', cardMarkup);
            });

            const statsPanel = document.getElementById('stats-panel');
            if (isRevealed && activeVotes.length > 0) {
                statsPanel.classList.remove('hidden');
                const avg = activeVotes.reduce((a, b) => a + b, 0) / activeVotes.length;
                const sorted = [...activeVotes].sort((a, b) => a - b);
                const med = sorted[Math.floor(sorted.length / 2)];
                const counts = activeVotes.reduce((a, c) => { a[c] = (a[c] || 0) + 1; return a; }, {});
                const mode = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

                document.getElementById('stat-avg').innerText = avg.toFixed(1);
                document.getElementById('stat-med').innerText = med;
                document.getElementById('stat-mode').innerText = mode;
            } else {
                statsPanel.classList.add('hidden');
            }
        }

        function copyRoomLink() {
            navigator.clipboard.writeText(window.location.href);
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        }
        setInterval(render, 3000);
    </script>
</body>

</html>